# 功能更新说明 - 协议格式兼容与历史记录

**日期**: 2025-11-01  
**版本**: v1.2.0  
**分类**: 功能增强

---

## 更新内容

### 1. 协议格式自动转换

新增协议格式转换器 (`core/protocol_converter.py`)，支持两种JSON格式：

#### 标准格式（程序内部格式）
```json
{
  "protocol_name": "协议名称",
  "version": "1.0",
  "description": "协议说明",
  "frame_header": "68",
  "frame_tail": "16",
  "checksum_config": {
    "checksum_type": "累加和",
    "position": "帧尾前",
    "start_offset": 0,
    "end_offset": -1,
    "checksum_length": 1
  },
  "fields": [
    {
      "name": "字段名",
      "byte_count": 1,
      "field_type": "uint8",
      "description": "字段说明",
      "order": 0
    }
  ]
}
```

#### 扩展格式（工业协议常用格式，自动转换）
```json
{
  "protocol_name": "工业协议",
  "version": "1.0",
  "frame_header": "68",
  "frame_tail": "16",
  "checksum_config": {
    "checksum_type": "累加和",
    "start_offset": 0,
    "end_offset": -1,
    "checksum_length": 1
  },
  "fields": [
    {
      "index": 0,
      "name": "设备地址",
      "byte_count": 1,
      "field_type": "fixed",
      "value": "0x01",
      "format": "HEX",
      "description": "设备固定地址"
    },
    {
      "index": "2-51",
      "name": "IMEI",
      "byte_count": 50,
      "field_type": "array",
      "format": "ASCII",
      "description": "IMEI号码数组"
    }
  ]
}
```

**扩展格式特性**：
- `index`: 字段索引，支持范围（如 "2-51"）
- `value`: 固定值
- `format`: HEX/ASCII
- `field_type`: fixed/variable/command/array/checksum（自动转换为标准类型）
- `byte_order`: 字节序（可选）
- `special_notes`: 特殊说明数组（可选）

**转换规则**：
- `fixed` → `bytes`
- `variable` → `bytes`
- `command` → `uint8`
- `array` → `bytes`
- `checksum` 类型字段会被自动识别并跳过

### 2. 协议格式说明Tab

在UI中新增"协议格式说明"标签页，包含：
- 两种JSON格式的完整示例
- 字段说明和类型映射
- 使用提示

**访问方式**：主窗口 → 协议格式说明 Tab

### 3. 协议历史记录功能

新增历史记录管理器 (`core/protocol_history.py`)：

**功能特性**：
- 自动记录最近加载的10个协议文件
- 历史记录保存在 `~/.serialdatacompare/protocol_history.json`
- 自动过滤已删除的文件
- 支持快速切换协议

**使用方式**：
1. 菜单栏 → 文件 → 最近的协议
2. 点击协议名称快速加载
3. 可清空历史记录

**数据结构**：
```json
{
  "history": [
    {
      "path": "/path/to/protocol.json",
      "name": "协议名称"
    }
  ]
}
```

---

## 文件清单

### 新增文件
- `core/protocol_converter.py` - 协议格式转换器
- `core/protocol_history.py` - 历史记录管理器
- `protocol_extended_example.json` - 扩展格式示例协议

### 修改文件
- `core/protocol_manager.py` - 集成格式转换器
- `main_window.py` - 添加历史记录菜单和加载逻辑
- `form.ui` - 添加协议格式说明Tab

---

## 使用场景

### 场景1：导入AI生成的协议JSON

用户可以让ChatGPT、Claude等AI助手根据协议文档生成JSON文件，无需担心格式差异：

**用户**: "帮我生成一个串口协议JSON，包含设备地址、命令码、50字节IMEI数组"

**AI生成扩展格式** → **程序自动转换** → **正常使用**

### 场景2：快速切换协议

测试多个设备时，可以快速在历史记录中切换协议配置，无需重复浏览文件。

### 场景3：兼容旧格式

如果有现存的工业协议JSON文件（如用户提供的83字节协议），程序会自动识别并转换。

---

## 技术细节

### 格式检测算法
```python
def detect_format(data: Dict[str, Any]) -> str:
    # 检查第一个字段
    first_field = data['fields'][0]
    
    # 扩展格式特征
    if 'index' in first_field or 'value' in first_field:
        return 'extended'
    
    # 标准格式特征
    if 'name' in first_field and 'field_type' in first_field:
        return 'standard'
    
    return 'unknown'
```

### 类型转换映射
| 扩展格式 | 标准格式 |
|---------|---------|
| fixed | bytes |
| variable | bytes |
| command | uint8 |
| array | bytes |
| checksum | uint8（自动跳过） |

---

## 注意事项

1. **帧头、帧尾、校验码**：无需在 `fields` 中定义，在协议配置中统一管理
2. **字段顺序**：自动按 `order` 字段排序
3. **历史记录限制**：默认保存最近10个协议，可在 `ProtocolHistory` 初始化时修改
4. **文件路径**：历史记录使用绝对路径，移动文件会导致记录失效
5. **错误处理**：导入失败时会显示详细错误信息，可根据提示修正JSON格式

---

## 测试建议

1. 测试标准格式导入：使用 `protocol_example.json`
2. 测试扩展格式导入：使用 `protocol_extended_example.json`
3. 测试历史记录：加载多个协议后，检查"最近的协议"菜单
4. 测试错误处理：尝试导入格式错误的JSON文件
5. 测试实际数据：使用实际设备数据验证解析正确性

---

## 后续计划

- [ ] 支持更多协议格式（XML、YAML等）
- [ ] 协议模板库
- [ ] 协议导入向导
- [ ] 协议对比工具
