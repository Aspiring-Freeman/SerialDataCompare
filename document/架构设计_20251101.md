# 系统架构设计文档

**创建日期**：2025-11-01  
**版本**：V1.0  
**作者**：AI Assistant

## 一、系统概述

串口数据分析工具是一个基于Python和PySide6开发的桌面应用程序，用于解析和验证串口通信数据帧。

### 1.1 设计目标
- 清晰的模块化架构，易于维护和扩展
- 支持自定义协议配置
- 灵活的校验算法，支持自定义校验范围
- 友好的用户界面
- 高性能的数据解析

### 1.2 技术栈
- **语言**：Python 3.10+
- **GUI框架**：PySide6 (Qt 6.10)
- **开发工具**：VS Code, Qt Creator
- **虚拟环境**：venv

## 二、系统架构

### 2.1 分层架构

```
┌─────────────────────────────────────────┐
│           用户界面层 (UI Layer)          │
│         main_window.py + ui_form.py     │
└─────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────┐
│         业务逻辑层 (Business Layer)      │
│   - DataParser (数据解析)               │
│   - ProtocolManager (协议管理)          │
│   - ChecksumValidator (校验验证)        │
└─────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────┐
│         数据模型层 (Model Layer)         │
│   - ProtocolConfig (协议配置)           │
│   - DataFrame (数据帧)                  │
│   - ParseResult (解析结果)              │
└─────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────┐
│         工具层 (Utility Layer)           │
│   - 文件I/O, 数据转换, 导出功能         │
└─────────────────────────────────────────┘
```

### 2.2 目录结构

```
SerialDataCompare/
├── main_window.py          # 主窗口（UI层）
├── ui_form.py             # 生成的UI代码
├── form.ui                # Qt Designer UI文件
│
├── models/                # 数据模型层
│   ├── __init__.py
│   ├── protocol.py        # 协议配置模型
│   └── data_frame.py      # 数据帧模型
│
├── core/                  # 核心业务逻辑层
│   ├── __init__.py
│   ├── parser.py          # 数据解析器
│   ├── checksum.py        # 校验算法
│   └── protocol_manager.py # 协议管理器
│
├── utils/                 # 工具层
│   ├── __init__.py
│   └── helpers.py         # 工具函数
│
├── document/              # 文档目录
│   ├── README_文档目录.md
│   ├── 功能说明.md
│   └── ...
│
└── .vscode/               # VS Code配置
    ├── settings.json
    ├── launch.json
    └── tasks.json
```

## 三、核心模块设计

### 3.1 数据模型层 (models/)

#### ProtocolConfig - 协议配置
**职责**：定义和管理通信协议的所有配置信息

**主要属性**：
- `protocol_name`: 协议名称
- `frame_header`: 帧头标识（十六进制字符串）
- `frame_tail`: 帧尾标识（十六进制字符串）
- `checksum_config`: 校验配置对象
- `fields`: 字段定义列表

**主要方法**：
- `add_field()`: 添加字段
- `remove_field()`: 删除字段
- `move_field_up/down()`: 调整字段顺序
- `to_dict()` / `from_dict()`: 序列化/反序列化

#### ChecksumConfig - 校验配置
**职责**：管理校验相关的所有参数

**主要属性**：
- `checksum_type`: 校验类型（枚举）
- `position`: 校验码位置（枚举）
- `start_offset`: 校验起始偏移
- `end_offset`: 校验结束偏移
- `checksum_length`: 校验码字节数

#### FieldDefinition - 字段定义
**职责**：定义数据帧中的单个字段

**主要属性**：
- `name`: 字段名称
- `byte_count`: 字节数（0表示变长）
- `field_type`: 数据类型（枚举）
- `description`: 字段说明
- `length_field`: 变长字段的长度字段名

#### DataFrame - 数据帧
**职责**：表示解析后的单个数据帧

**主要属性**：
- `frame_number`: 帧序号
- `start_position` / `end_position`: 在原始数据中的位置
- `raw_data`: 原始字节数据
- `fields`: 解析后的字段字典
- `checksum_valid`: 校验是否通过
- `error_message`: 错误信息

### 3.2 核心业务逻辑层 (core/)

#### DataParser - 数据解析器
**职责**：解析十六进制字符串，识别和解析数据帧

**工作流程**：
```
输入字符串 → parse_hex_string() → 字节数据
    ↓
find_frames() → 查找所有帧位置
    ↓
对每一帧：
    parse_single_frame()
        ├─ parse_frame_fields() → 解析字段
        └─ ChecksumValidator.validate_frame() → 校验
    ↓
返回 ParseResult
```

**关键方法**：
- `parse_hex_string()`: 转换十六进制字符串为字节
- `find_frames()`: 根据帧头帧尾查找所有帧
- `parse_frame_fields()`: 解析帧中的所有字段
- `parse_field()`: 解析单个字段
- `parse()`: 主解析方法

#### ChecksumCalculator - 校验计算器
**职责**：计算各种校验值

**支持的校验算法**：
- 累加和 (SUM)：所有字节相加取低8位
- 异或校验 (XOR)：所有字节异或
- CRC16：使用0xA001多项式
- CRC32：使用0xEDB88320多项式

**关键方法**：
- `calculate()`: 统一的计算接口
- `_calculate_sum()`: 累加和实现
- `_calculate_xor()`: 异或实现
- `_calculate_crc16()`: CRC16实现
- `_calculate_crc32()`: CRC32实现

#### ChecksumValidator - 校验验证器
**职责**：验证数据帧的校验码

**关键特性**：
- 支持自定义校验范围（start_offset, end_offset）
- 支持1-4字节的校验码
- 支持小端序/大端序

**关键方法**：
- `validate_frame()`: 验证帧校验
- `get_checksum_info()`: 获取校验码信息（调试用）

#### ProtocolManager - 协议管理器
**职责**：管理协议配置的持久化

**主要功能**：
- 保存协议到JSON文件
- 从JSON文件加载协议
- 验证协议配置的有效性
- 提供默认协议

### 3.3 用户界面层 (main_window.py)

#### Main - 主窗口类
**职责**：连接UI和业务逻辑，处理用户交互

**主要功能模块**：

**1. 数据分析Tab**
- 输入数据
- 触发解析
- 显示结果统计
- 填充帧列表表格
- 显示帧详情
- 导出结果

**2. 协议配置Tab**
- 基本参数配置
- 字段表格管理（可编辑）
- 校验范围配置
- 协议文件操作

**3. 设置Tab**
- 显示设置
- 关于信息

**关键设计模式**：
- **MVC模式**：UI（View）、数据模型（Model）、业务逻辑（Controller）分离
- **观察者模式**：使用Qt信号槽机制
- **线程模式**：使用ParseThread进行异步解析，避免UI阻塞

## 四、数据流

### 4.1 解析数据流

```
用户输入十六进制字符串
    ↓
Main.on_analyze_clicked()
    ↓
创建 ParseThread
    ↓
ParseThread.run()
    ├─ DataParser.parse()
    │   ├─ parse_hex_string() → bytes
    │   ├─ find_frames() → [(start, end), ...]
    │   └─ 对每一帧：
    │       ├─ parse_frame_fields() → {field: value}
    │       └─ ChecksumValidator.validate_frame()
    ↓
ParseResult
    ↓
Main.on_parse_finished()
    ├─ 更新统计信息
    ├─ fill_frames_table()
    └─ 显示完成消息
```

### 4.2 协议配置流

```
UI配置 ←→ ProtocolConfig ←→ JSON文件
   ↑           ↓
   └─── 应用于 DataParser
```

## 五、扩展性设计

### 5.1 添加新的校验算法

1. 在 `models/protocol.py` 中的 `ChecksumType` 枚举添加新类型
2. 在 `core/checksum.py` 中的 `ChecksumCalculator` 类添加计算方法
3. 在UI的校验类型下拉框中添加选项

### 5.2 添加新的数据类型

1. 在 `models/protocol.py` 中的 `FieldType` 枚举添加新类型
2. 在 `core/parser.py` 中的 `parse_field()` 方法添加解析逻辑

### 5.3 添加新的导出格式

1. 在 `utils/helpers.py` 中添加新的导出函数
2. 在 `main_window.py` 的 `on_export_result_clicked()` 中添加新选项

## 六、性能考虑

### 6.1 大数据量处理
- 使用 `ParseThread` 异步解析，避免UI冻结
- 字节操作使用Python内置的 `bytes` 类型，高效快速
- 正则表达式优化，减少不必要的匹配

### 6.2 内存优化
- `DataFrame` 对象只保存必要信息
- 大文件导出时使用流式写入

### 6.3 UI响应性
- 表格使用 `blockSignals()` 避免频繁刷新
- 耗时操作放在线程中执行

## 七、错误处理

### 7.1 数据输入错误
- 十六进制格式验证
- 不完整帧标记
- 友好的错误提示

### 7.2 协议配置错误
- 配置验证（ProtocolManager.validate_protocol）
- 字段重名检查
- 必填项检查

### 7.3 文件操作错误
- try-except包装所有I/O操作
- 返回布尔值标识成功/失败
- 显示具体错误信息

## 八、测试策略

### 8.1 单元测试（计划）
- 校验算法测试
- 数据解析测试
- 协议配置测试

### 8.2 集成测试（计划）
- 完整解析流程测试
- UI交互测试

### 8.3 手动测试
- 使用真实串口数据
- 边界条件测试
- 异常情况测试

## 九、未来改进方向

1. **实时串口监听**：集成串口通信库，实时接收和分析数据
2. **数据可视化**：添加图表显示，时序分析
3. **协议模板库**：内置常用协议模板
4. **自定义脚本**：支持Python脚本自定义解析和校验
5. **批量文件处理**：支持导入多个数据文件批量处理
6. **日志记录**：详细的操作日志和调试信息
7. **国际化**：多语言支持
8. **插件系统**：支持第三方扩展

## 十、总结

本系统采用清晰的分层架构和模块化设计，各模块职责明确，耦合度低，易于维护和扩展。通过合理使用设计模式和Python/Qt的特性，实现了一个功能完善、用户友好的串口数据分析工具。
